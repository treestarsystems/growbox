# Task: Create TFTP configuration, set up directories, manage service, and verify status with Ansible.
---
- name: "TFTP: Create TFTP configuration from template"
  ansible.builtin.template:
   src: tftpd-hpa.j2
   dest: /etc/default/tftpd-hpa
   owner: root
   group: root
   mode: "0644"
   backup: true
  become: true
  register: tftp_config
  tags:
   - tftp
   - config

- name: "TFTP: Create main TFTP directory"
  ansible.builtin.file:
   path: "{{ tftp_directory }}"
   state: directory
   owner: "{{ tftp_username }}"
   group: "{{ tftp_username }}"
   mode: "{{ tftp_directory_mode }}"
  become: true
  tags:
   - tftp
   - directories

- name: "TFTP: Create TFTP subdirectories"
  ansible.builtin.file:
   path: "{{ tftp_directory }}/{{ item }}"
   state: directory
   owner: "{{ tftp_username }}"
   group: "{{ tftp_username }}"
   mode: "{{ tftp_directory_mode }}"
  loop: "{{ tftp_subdirectories }}"
  become: true
  tags:
   - tftp
   - directories

- name: "TFTP: Ensure tftpd-hpa service is enabled"
  ansible.builtin.systemd:
   name: tftpd-hpa
   enabled: true
   daemon_reload: true
  become: true
  tags:
   - tftp
   - service

- name: "TFTP: Start tftpd-hpa service"
  ansible.builtin.systemd:
   name: tftpd-hpa
   state: started
  become: true
  tags:
   - tftp
   - service

- name: "TFTP: Restart tftpd-hpa if configuration changed"
  ansible.builtin.systemd:
   name: tftpd-hpa
   state: restarted
  become: true
  when: tftp_config.changed
  tags:
   - tftp
   - service

- name: "TFTP: Wait for TFTP service to be ready"
  ansible.builtin.wait_for:
   port: 69
   host: "{{ vlan6_address | ansible_host | default('172.16.0.20') }}"
   timeout: 30
   delay: 2
  become: true
  tags:
   - tftp
   - verify

- name: "TFTP: Get tftpd-hpa service status"
  ansible.builtin.command: systemctl status tftpd-hpa
  become: true
  register: tftp_service_status
  changed_when: false
  failed_when: false
  tags:
   - tftp
   - verify

- name: "TFTP: Display TFTP service status"
  ansible.builtin.debug:
   var: tftp_service_status.stdout_lines
  tags:
   - tftp
   - verify

- name: "TFTP: Verify TFTP directories exist"
  ansible.builtin.stat:
   path: "{{ tftp_directory }}/{{ item }}"
  loop: "{{ tftp_subdirectories }}"
  register: tftp_dir_check
  tags:
   - tftp
   - verify

- name: "TFTP: Display TFTP directory status"
  ansible.builtin.debug:
   msg: "Directory {{ item.item }} exists: {{ item.stat.exists }}"
  loop: "{{ tftp_dir_check.results }}"
  loop_control:
   label: "{{ item.item }}"
  tags:
   - tftp
   - verify

- name: "TFTP: Reboot system to apply all changes"
  ansible.builtin.reboot:
   msg: "Reboot initiated by Ansible"
   connect_timeout: 5
   reboot_timeout: 600
   pre_reboot_delay: 0
   post_reboot_delay: 30
   test_command: uptime
  become: true
  when:
   - tftp_config.changed
   - not skip_reboot | bool
  tags:
   - reboot

- name: "TFTP: Wait for system to be reachable after reboot"
  ansible.builtin.wait_for_connection:
   connect_timeout: 20
   sleep: 5
   delay: 5
   timeout: 300
  when:
   - tftp_config.changed
   - not skip_reboot | bool
  tags:
   - reboot

- name: "TFTP: Verify TFTP service after reboot"
  ansible.builtin.systemd:
   name: tftpd-hpa
  become: true
  register: tftp_post_reboot
  when: tftp_config.changed
  tags:
   - tftp
   - verify

- name: "TFTP: Display TFTP service status after reboot"
  ansible.builtin.debug:
   msg: "TFTP service is {{ tftp_post_reboot.status.ActiveState }} after reboot"
  when: tftp_config.changed
  tags:
   - tftp
   - verify
