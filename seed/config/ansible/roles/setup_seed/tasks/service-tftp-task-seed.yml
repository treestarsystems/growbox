# Task: Create TFTP configuration, set up directories, manage service, and verify status with Ansible.
---
- name: "TFTP: Create TFTP configuration from template"
  ansible.builtin.template:
   src: tftpd-hpa.j2
   dest: /etc/default/tftpd-hpa
   owner: root
   group: root
   mode: "0644"
   backup: true
  become: true
  register: setup_seed_tftp_config
  tags:
   - tftp
   - config

- name: "TFTP: Create main TFTP directory"
  ansible.builtin.file:
   path: "{{ setup_seed_tftp_directory }}"
   state: directory
   owner: "{{ setup_seed_tftp_username }}"
   group: "{{ setup_seed_tftp_username }}"
   mode: "{{ setup_seed_tftp_directory_mode }}"
  become: true
  tags:
   - tftp
   - directories

- name: "TFTP: Ensure tftpd-hpa service is enabled"
  ansible.builtin.systemd:
   name: tftpd-hpa
   enabled: true
   daemon_reload: true
  become: true
  tags:
   - tftp
   - service

- name: "TFTP: Start tftpd-hpa service"
  ansible.builtin.systemd:
   name: tftpd-hpa
   state: started
  become: true
  tags:
   - tftp
   - service

- name: "TFTP: Restart tftpd-hpa if configuration changed"
  ansible.builtin.systemd:
   name: tftpd-hpa
   state: restarted
  become: true
  when: setup_seed_tftp_config.changed
  tags:
   - tftp
   - service

- name: "TFTP: Wait until tftpd-hpa is active"
  ansible.builtin.shell: systemctl is-active tftpd-hpa
  register: setup_seed_tftp_active
  become: true
  changed_when: false
  retries: 10
  delay: 3
  until: setup_seed_tftp_active.stdout == "active"
  tags:
   - tftp
   - verify

- name: "TFTP: Display listening status"
  ansible.builtin.debug:
   msg: "TFTP is listening: {{ setup_seed_tftp_active.stdout }}"
  tags:
   - tftp
   - verify

- name: "TFTP: Verify TFTP directories exist"
  ansible.builtin.stat:
   path: "{{ setup_seed_tftp_directory }}"
  register: setup_seed_tftp_dir_check
  tags:
   - tftp
   - verify

- name: "TFTP: Display TFTP directory status"
  ansible.builtin.debug:
   msg: "Directory {{ setup_seed_tftp_directory }} exists: {{ setup_seed_tftp_dir_check.stat.exists }}"
  tags:
   - tftp
   - verify

- name: "TFTP: Reboot system to apply all changes"
  ansible.builtin.reboot:
   msg: "Reboot initiated by Ansible"
   connect_timeout: 5
   reboot_timeout: 600
   pre_reboot_delay: 0
   post_reboot_delay: 30
   test_command: uptime
  become: true
  when:
   - setup_seed_tftp_config.changed
   - not skip_reboot | bool
  tags:
   - reboot

- name: "TFTP: Wait for system to be reachable after reboot"
  ansible.builtin.wait_for_connection:
   connect_timeout: 20
   sleep: 5
   delay: 5
   timeout: 300
  when:
   - setup_seed_tftp_config.changed
   - not skip_reboot | bool
  tags:
   - reboot

- name: "TFTP: Verify TFTP service after reboot"
  ansible.builtin.systemd:
   name: tftpd-hpa
  become: true
  register: setup_seed_tftp_post_reboot
  when: setup_seed_tftp_config.changed
  tags:
   - tftp
   - verify

- name: "TFTP: Display TFTP service status after reboot"
  ansible.builtin.debug:
   msg: "TFTP service is {{ setup_seed_tftp_post_reboot.status.ActiveState }} after reboot"
  when: setup_seed_tftp_config.changed
  tags:
   - tftp
   - verify
